- name: Compliance de Servidor Linux
  hosts: web
  become: true
  gather_facts: true
 
  vars:
    allowed_users:
      - root
      - admin
    password_min_length: 12
    password_complexity: "YES"
    password_max_age: 100
    allowed_services:
      - sshd
      - chronyd
      - crond
    required_packages:
      - audit
      - rsyslog
 
  tasks:
 
    - name: Verificar edad máxima de contraseñas
      lineinfile:
        path: /etc/login.defs
        regexp: "^PASS_MAX_DAYS"
        line: "PASS_MAX_DAYS {{ password_max_age }}"
        state: present
      register: reemplazo

    - name: Dame un mensaje de consola
      ansible.builtin.debug:
        var: reemplazo

    - name: Mensaja linea Edad Días
      ansible.builtin.command:
        cmd: grep PASS_MAX_DAYS /etc/login.defs
      changed_when: false

    - name: Disable SSH Root Login Asegurarse de que el root sólo pueda hacer login desde la consola
      block:
      - name: Check for duplicate values
        lineinfile:
          path: /etc/ssh/sshd_config
          create: true
          regexp: (?i)^\s*PermitRootLogin\s+
          state: absent
        check_mode: true
        changed_when: false
        register: dupes
      - name: Deduplicate values from /etc/ssh/sshd_config
        lineinfile:
          path: /etc/ssh/sshd_config
          create: true
          regexp: (?i)^\s*PermitRootLogin\s+
          state: absent
        when: dupes.found is defined and dupes.found > 1
      - name: Insert correct line to /etc/ssh/sshd_config
        lineinfile:
          path: /etc/ssh/sshd_config
          create: true
          regexp: (?i)^\s*PermitRootLogin\s+
          line: PermitRootLogin no
          state: present
          insertbefore: BOF
          validate: /usr/sbin/sshd -t -f %s
      when:
      - DISA_STIG_RHEL_08_010550 | bool
      - low_complexity | bool
      - low_disruption | bool
      - medium_severity | bool
      - no_reboot_needed | bool
      - restrict_strategy | bool
      - sshd_disable_root_login | bool
      - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
      tags:
      - CCE-80901-2
      - CJIS-5.5.6
      - DISA-STIG-RHEL-08-010550
      - NIST-800-171-3.1.1
      - NIST-800-171-3.1.5
      - NIST-800-53-AC-17(a)
      - NIST-800-53-AC-6(2)
      - NIST-800-53-CM-6(a)
      - NIST-800-53-CM-7(a)
      - NIST-800-53-CM-7(b)
      - NIST-800-53-IA-2
      - NIST-800-53-IA-2(5)
      - PCI-DSS-Req-2.2.4
      - PCI-DSSv4-2.2.6
      - low_complexity
      - low_disruption
      - medium_severity
      - no_reboot_needed
      - restrict_strategy
      - sshd_disable_root_login
          
    
    - name: Reporte de compliance final
      debug:
        msg: "Verificación de compliance completada en el servidor {{ inventory_hostname }}. Por favor, revisa los registros de tareas fallidas para conocer más detalles."
