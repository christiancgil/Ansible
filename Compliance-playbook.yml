- name: Compliance de Servidor Linux
  hosts: web
  become: true
  gather_facts: true
 
  vars:
    allowed_users:
      - root
      - admin
    password_min_length: 12
    password_complexity: "YES"
    password_max_age: 100
    allowed_services:
      - sshd
      - chronyd
      - crond
    required_packages:
      - audit
      - rsyslog
 
  tasks:
 
    - name: Verificar edad máxima de contraseñas
      lineinfile:
        path: /etc/login.defs
        regexp: "^PASS_MAX_DAYS"
        line: "PASS_MAX_DAYS {{ password_max_age }}"
        state: present
      register: reemplazo

    - name: Dame un mensaje
      ansible.builtin.debug:
        var: reemplazo

    - name: Mensaja linea Edad Días
      ansible.builtin.command:
        cmd: grep PASS_MAX_DAYS /etc/login.defs
      changed_when: false

    - name: Disable SSH Root Login Asegurarse de que el root sólo pueda hacer login desde la consola
      block:
      debug:
        msg: "Verificación de compliance completada en el servidor {{ inventory_hostname }}. Por favor, revisa los registros de tareas fallidas para conocer más detalles."

    - name: Check for duplicate values
      lineinfile:
        path: /etc/ssh/sshd_config
        create: true
        regexp: (?i)^\s*PermitRootLogin\s+
        state: absent
      check_mode: true
      changed_when: false
      register: dupes
      debug:
        msg: "Verificación de compliance completada en el servidor {{ inventory_hostname }}. Por favor, revisa los registros de tareas fallidas para conocer más detalles."

    - name: Reporte de compliance final
      debug:
        msg: "Verificación de compliance completada en el servidor {{ inventory_hostname }}. Por favor, revisa los registros de tareas fallidas para conocer más detalles."
